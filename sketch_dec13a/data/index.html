<!DOCTYPE HTML><html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Ivaylo's Surveillance Camera</title>
</head>
<body>
    <div id="container">
        <h1>WebSocket Camera Feed</h1>
        <div id="button-container">
             <button onclick="capturePhoto()" class="capture_email_button">CAPTURE PHOTO</button>
             <button onclick="location.reload()" class="Refresh_button" type="button">
                 <svg viewBox="0 0 16 16" class="bi bi-arrow-repeat" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                     <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"></path>
                     <path d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z" fill-rule="evenodd"></path>
                 </svg>
                 REFRESH
             </button>
           
             <button  onclick="emailPhoto();" class="capture_email_button">EMAIL PHOTO</button>
             <button onclick="toggleFlashlight()" class="capture_email_button">Flashlight</button>
        </div>
        <div id="live-container">
             <img id="live" src="">
             <br>
             <img src="saved-photo" id="photo" width="20%">
             
             <div id="servo-container">
                 <p>UP and DOWN</p>
                 <input type="range" min="0" max="50" class="slider" id="servoSlider1" value="25" />
                 <p id="servoPos1">25</p>
             
                 <p>LEFT and RIGHT:</p>
                 <input type="range" min="0" max="180" class="slider" id="servoSlider2" value="90" />
                 <p id="servoPos2">90</p>
             </div>
        </div> 
     </div>
      
</body>
<script>
var gateway = `ws://${window.location.hostname}/ws`;
var socket;
var userPresent = true; // Assume the user is initially present

if (!('WebSocket' in window)) {
    alert('Your browser does not support web sockets');
} else {
    setupWebSocket();
}

function setupWebSocket() {
    var host = 'ws://' + window.location.hostname + ':81';
    socket = new WebSocket(host);
    socket.binaryType = 'arraybuffer';

    if (socket) {
        socket.onopen = function () {
            console.log('WebSocket connection opened');
        }

        socket.onmessage = function (msg) {
            var bytes = new Uint8Array(msg.data);
            var binary = '';
            var len = bytes.byteLength;

            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }

            var img = document.getElementById('live');
            img.src = 'data:image/jpg;base64,' + window.btoa(binary);
        }

        socket.onclose = function () {
            console.log('WebSocket connection closed');

        //     if (userPresent && socket.readyState == WebSocket.OPEN) {
        //     socket.send("userLeaving");
        // }
        }

        // Track the last time the mouse moved
var lastMouseMoveTime = Date.now();

document.addEventListener('mousemove', function() {
    // Update the last mouse move time
    lastMouseMoveTime = Date.now();
});

function notifyUserPresence(present) {
    userPresent = present;
    if (socket && socket.readyState == WebSocket.OPEN) {
        socket.send(present ? "userPresent" : "userNotPresent");
    }
}

setInterval(function() {
    // Check if there has been mouse movement in the last minute
    var currentTime = Date.now();
    var userActive = currentTime - lastMouseMoveTime <= 10000;
    // Notify ESP32-CAM about user presence and PIR motion
    notifyUserPresence(userActive);

    }, 10000); // Adjust the interval based on your preference
    }
}

function toggleFlashlight() {
    if (socket && socket.readyState == WebSocket.OPEN) {
        socket.send("toggleFlashlight");
    }
}

function capturePhoto() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "/capture", true);
    xhr.send();

    // Reload the page after capturing the photo
    setTimeout(function() {
        location.reload();
    }, 1000); // Adjust the delay based on your server processing time
}

function emailPhoto() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "/email-photo", true);
    xhr.send();
}

function setupSlider(servoId) {
    var slider = document.getElementById(`servoSlider${servoId}`);
    slider.addEventListener('change', function(event) {
        var angle = event.target.value;
        updateServoAngle(servoId, angle);
    });
}

function updateServoAngle(servoId, angle) {
    // Update the displayed angle value
    document.getElementById(`servoPos${servoId}`).textContent = angle;

    // Send the servo angle to the ESP32-CAM server
    setServoAngle(servoId, angle);
}

function setServoAngle(servoId, angle) {
    // Create a new XMLHttpRequest object
    var xhr = new XMLHttpRequest();
    
    // Configure the request
    xhr.open("GET", `/set-servo-angle?servoId=${servoId}&angle=${angle}`, true);

    // Define the callback function to handle the server response
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                // Request was successful, handle response if needed
                console.log(xhr.responseText);
            } else {
                // Request failed, handle error if needed
                console.error("Failed to set servo angle");
            }
        }
    };

    // Send the GET request
    xhr.send();
}

// Call setupSlider for each servo
setupSlider(1); // For servo 1
setupSlider(2); // For servo 2



</script>

</body>
</html>